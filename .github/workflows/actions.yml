name: Generate README

on:
  push:
    branches:
      - '*'  # Trigger on push to any branch

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Install Ruby
        run: sudo apt install ruby-full

      - name: Install Asciidoctor
        run: |
          sudo gem install asciidoctor  # Install the Asciidoctor gem

      - name: Create HTMLs
        run: |
          # Create or clear README-NEW.md
          > README-NEW.md
          echo "# Contents" >> README-NEW.md
          pwd
          ls
          # Iterate over directories containing .adoc files (up to maxdepth 2)
          for dir in $(find . -maxdepth 2 -type f -name "*.adoc" -exec dirname {} \; | sort -u); do
            # Only process directories one level deep in the repo
            if [[ $(echo "$dir" | grep -o '/' | wc -l) -eq 1 ]]; then
              echo "Processing directory: $dir"

              # Create master.adoc file
              master_adoc="$dir/master.adoc"
              echo "=  $dir" > "$master_adoc"  # Add a title to the master file

              # Append all .adoc files in the directory to the master.adoc file
              for file in $(find "$dir" -maxdepth 1 -type f -name "*.adoc" | sort -u); do
                if ! echo "$file" | grep -q "master.adoc"; then
                  cleaned_file=$(basename "$file")
                  echo "include::$cleaned_file[]" >> "$master_adoc"
                fi
              done
              cat  "$dir/master.adoc"
              # Generate HTML from master.adoc
              pwd
              asciidoctor "$master_adoc"

              # Remove the temporary master.adoc file after processing
              rm "$master_adoc"

              # Add section for this directory in README-NEW.md
              echo "## [$dir] (~/$dir/master.html)" >> README-NEW.md

              # Find all HTML files in the directory and append them to README-NEW.md
              for html_file in $(find "$dir" -name "*.html" | sort); do
                if [ -f "$html_file" ]; then
                  if ! echo "$html_file" | grep -q "master.html"; then
                    echo "### [$html_file](~/$html_file)" >> README-NEW.md
                  fi
                fi
              done
            fi
          done

          # Print the generated README content for debugging
          cat README-NEW.md

      - name: Upload HTML files as artifacts
        uses: actions/upload-artifact@v3
        with:
          name: html-output
          path: '**/*.html'

      - name: Upload README file as artifacts
        uses: actions/upload-artifact@v3
        with:
          name: README-NEW
          path: '**/*.md'